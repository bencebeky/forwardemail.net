"use strict";

const fs = require('fs');

const FormData = require('form-data');

const Frisbee = require('frisbee');

const _ = require('lodash');

const safeStringify = require('fast-safe-stringify');

const universalify = require('universalify');

const {
  boolean
} = require('boolean'); // Object.keys(require('sharp').prototype).filter(key => !key.startsWith('_'))


const keys = ['metadata', 'limitInputPixels', 'sequentialRead', 'resize', 'crop', 'embed', 'max', 'min', 'ignoreAspectRatio', 'withoutEnlargement', 'overlayWith', 'rotate', 'extract', 'flip', 'flop', 'sharpen', 'blur', 'extend', 'flatten', 'trim', 'gamma', 'negate', 'normalise', 'normalize', 'convolve', 'threshold', 'boolean', 'background', 'greyscale', 'grayscale', 'toColourspace', 'toColorspace', 'extractChannel', 'joinChannel', 'bandbool', 'toFile', 'toBuffer', 'withMetadata', 'jpeg', 'png', 'webp', 'tiff', 'raw', 'toFormat', 'tile'];

class Lipo {
  constructor(config = {}) {
    this.__config = {
      key: process.env.LIPO_KEY || '',
      baseURI: process.env.LIPO === 'true' ? 'http://localhost:3000' : 'https://api.lipo.io',
      ...config
    };
    this.__api = new Frisbee({
      baseURI: this.__config.baseURI,
      headers: {
        Accept: 'application/json'
      }
    });
    if (this.__config.key) this.__api.auth(this.__config.key);
    this.__queue = [];
    this.__metadata = universalify.fromPromise(this.__metadata);
    this.__toFile = universalify.fromPromise(this.__toFile);
    this.__toBuffer = universalify.fromPromise(this.__toBuffer);
    return input => {
      this.__input = input;
      return this;
    };
    /*
    // <https://github.com/lovell/sharp/issues/1045>
    return (input, options = {}) => {
      this.__input = null;
      this.__options = {};
      // input = Buffer | String
      // options = Object
      // - density (Number)
      // - raw (Object)
      //   - width (Number)
      //   - height (Number)
      //   - channels (Number; 1-4)
      // - create (Object)
      //   - width (Number)
      //   - height (Number)
      //   - channels (Number; 3-4)
      //   - background (String | Object)
      if (_.isString(input) || _.isBuffer(input)) this.__input = input;
      else if (_.isObject(this.__input)) this.__options = input;
      if (!_.isObject(this.__input) && _.isObject(options))
        this._options = options;
      return this;
    };
    */
  }

  async __metadata() {
    const body = new FormData();
    if (_.isString(this.__input)) body.append('input', fs.createReadStream(this.__input));else if (_.isBuffer(this.__input)) body.append('input', this.__input);else if (_.isObject(this.__input)) body.append('options', safeStringify(this.__input));
    body.append('queue', safeStringify(this.__queue));
    this.__queue = [];
    const res = await this.__api.post('/', {
      body
    });
    if (res.err) throw res.err;
    return res.body;
  }

  async __toFile(fileOut) {
    if (!_.isString(fileOut)) throw new Error('File output path required');
    const body = new FormData();
    if (_.isString(this.__input)) body.append('input', fs.createReadStream(this.__input));else if (_.isBuffer(this.__input)) body.append('input', this.__input);else if (_.isObject(this.__input)) body.append('options', safeStringify(this.__input));
    body.append('queue', safeStringify(this.__queue));
    this.__queue = [];
    const res = await this.__api.post('/', {
      body,
      raw: true
    });
    if (res.err) throw res.err;
    this.__info = {
      format: res.headers.get('x-sharp-format'),
      size: Number(res.headers.get('x-sharp-size')),
      width: Number(res.headers.get('x-sharp-width')),
      height: Number(res.headers.get('x-sharp-height')),
      channels: Number(res.headers.get('x-sharp-channels')),
      premultiplied: boolean(res.headers.get('x-sharp-multiplied'))
    };
    const stream = fs.createWriteStream(fileOut); // let timer;
    // stream.on('open', () => {
    //   timer = setTimeout(() => {
    //     stream.close();
    //     reject(new Error('Timed out while writing file'));
    //   }, 10000);
    // });

    const promise = new Promise((resolve, reject) => {
      stream.on('error', reject).on('finish', () => {
        resolve(this.__info);
      });
      res.body.on('error', reject).pipe(stream);
    });
    return promise;
  }

  async __toBuffer(options = {}) {
    const body = new FormData();
    if (_.isString(this.__input)) body.append('input', fs.createReadStream(this.__input));else if (_.isBuffer(this.__input)) body.append('input', this.__input);else if (_.isObject(this.__input)) body.append('options', safeStringify(this.__input));
    body.append('queue', safeStringify(this.__queue));
    this.__queue = [];
    const res = await this.__api.post('/', {
      body,
      raw: true
    });
    if (res.err) throw res.err;
    this.__info = {
      format: res.headers.get('x-sharp-format'),
      size: Number(res.headers.get('x-sharp-size')),
      width: Number(res.headers.get('x-sharp-width')),
      height: Number(res.headers.get('x-sharp-height')),
      channels: Number(res.headers.get('x-sharp-channels')),
      premultiplied: boolean(res.headers.get('x-sharp-multiplied'))
    };
    const data = await res.buffer();
    if (_.isObject(options) && boolean(options.resolveWithObject)) return {
      data,
      info: this.__info
    };
    return data;
  }

  clone() {
    return new Lipo({ ...this.__config
    })(this.__input);
  }

}

keys.forEach(key => {
  Lipo.prototype[key] = function (...args) {
    if (!['toFile', 'toBuffer', 'metadata'].includes(key)) {
      this.__queue.push([key].concat(args));

      return this;
    }

    if (key === 'metadata') {
      this.__queue.push(['metadata']);

      return this.__metadata(...args);
    }

    if (key === 'toFile') return this.__toFile(...args);
    return this.__toBuffer(...args);
  };
}); // Sourced from `lib/resize.js`:
// <https://github.com/lovell/sharp/blob/master/lib/resize.js>
// Weighting to apply when using contain/cover fit.

Lipo.gravity = {
  center: 0,
  centre: 0,
  north: 1,
  east: 2,
  south: 3,
  west: 4,
  northeast: 5,
  southeast: 6,
  southwest: 7,
  northwest: 8
}; // Position to apply when using contain/cover fit.

Lipo.position = {
  top: 1,
  right: 2,
  bottom: 3,
  left: 4,
  'right top': 5,
  'right bottom': 6,
  'left bottom': 7,
  'left top': 8
}; // Strategies for automagic cover behaviour.

Lipo.strategy = {
  entropy: 16,
  attention: 17
}; // Reduction kernels.

Lipo.kernel = {
  nearest: 'nearest',
  cubic: 'cubic',
  lanczos2: 'lanczos2',
  lanczos3: 'lanczos3'
}; // Methods by which an image can be resized to fit the provided dimensions.

Lipo.fit = {
  contain: 'contain',
  cover: 'cover',
  fill: 'fill',
  inside: 'inside',
  outside: 'outside'
};
module.exports = Lipo;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJGb3JtRGF0YSIsIkZyaXNiZWUiLCJfIiwic2FmZVN0cmluZ2lmeSIsInVuaXZlcnNhbGlmeSIsImJvb2xlYW4iLCJrZXlzIiwiTGlwbyIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiX19jb25maWciLCJrZXkiLCJwcm9jZXNzIiwiZW52IiwiTElQT19LRVkiLCJiYXNlVVJJIiwiTElQTyIsIl9fYXBpIiwiaGVhZGVycyIsIkFjY2VwdCIsImF1dGgiLCJfX3F1ZXVlIiwiX19tZXRhZGF0YSIsImZyb21Qcm9taXNlIiwiX190b0ZpbGUiLCJfX3RvQnVmZmVyIiwiaW5wdXQiLCJfX2lucHV0IiwiYm9keSIsImlzU3RyaW5nIiwiYXBwZW5kIiwiY3JlYXRlUmVhZFN0cmVhbSIsImlzQnVmZmVyIiwiaXNPYmplY3QiLCJyZXMiLCJwb3N0IiwiZXJyIiwiZmlsZU91dCIsIkVycm9yIiwicmF3IiwiX19pbmZvIiwiZm9ybWF0IiwiZ2V0Iiwic2l6ZSIsIk51bWJlciIsIndpZHRoIiwiaGVpZ2h0IiwiY2hhbm5lbHMiLCJwcmVtdWx0aXBsaWVkIiwic3RyZWFtIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJwcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJvbiIsInBpcGUiLCJvcHRpb25zIiwiZGF0YSIsImJ1ZmZlciIsInJlc29sdmVXaXRoT2JqZWN0IiwiaW5mbyIsImNsb25lIiwiZm9yRWFjaCIsInByb3RvdHlwZSIsImFyZ3MiLCJpbmNsdWRlcyIsInB1c2giLCJjb25jYXQiLCJncmF2aXR5IiwiY2VudGVyIiwiY2VudHJlIiwibm9ydGgiLCJlYXN0Iiwic291dGgiLCJ3ZXN0Iiwibm9ydGhlYXN0Iiwic291dGhlYXN0Iiwic291dGh3ZXN0Iiwibm9ydGh3ZXN0IiwicG9zaXRpb24iLCJ0b3AiLCJyaWdodCIsImJvdHRvbSIsImxlZnQiLCJzdHJhdGVneSIsImVudHJvcHkiLCJhdHRlbnRpb24iLCJrZXJuZWwiLCJuZWFyZXN0IiwiY3ViaWMiLCJsYW5jem9zMiIsImxhbmN6b3MzIiwiZml0IiwiY29udGFpbiIsImNvdmVyIiwiZmlsbCIsImluc2lkZSIsIm91dHNpZGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBRUEsTUFBTUMsUUFBUSxHQUFHRCxPQUFPLENBQUMsV0FBRCxDQUF4Qjs7QUFDQSxNQUFNRSxPQUFPLEdBQUdGLE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUNBLE1BQU1HLENBQUMsR0FBR0gsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTUksYUFBYSxHQUFHSixPQUFPLENBQUMscUJBQUQsQ0FBN0I7O0FBQ0EsTUFBTUssWUFBWSxHQUFHTCxPQUFPLENBQUMsY0FBRCxDQUE1Qjs7QUFDQSxNQUFNO0FBQUVNLEVBQUFBO0FBQUYsSUFBY04sT0FBTyxDQUFDLFNBQUQsQ0FBM0IsQyxDQUVBOzs7QUFDQSxNQUFNTyxJQUFJLEdBQUcsQ0FDWCxVQURXLEVBRVgsa0JBRlcsRUFHWCxnQkFIVyxFQUlYLFFBSlcsRUFLWCxNQUxXLEVBTVgsT0FOVyxFQU9YLEtBUFcsRUFRWCxLQVJXLEVBU1gsbUJBVFcsRUFVWCxvQkFWVyxFQVdYLGFBWFcsRUFZWCxRQVpXLEVBYVgsU0FiVyxFQWNYLE1BZFcsRUFlWCxNQWZXLEVBZ0JYLFNBaEJXLEVBaUJYLE1BakJXLEVBa0JYLFFBbEJXLEVBbUJYLFNBbkJXLEVBb0JYLE1BcEJXLEVBcUJYLE9BckJXLEVBc0JYLFFBdEJXLEVBdUJYLFdBdkJXLEVBd0JYLFdBeEJXLEVBeUJYLFVBekJXLEVBMEJYLFdBMUJXLEVBMkJYLFNBM0JXLEVBNEJYLFlBNUJXLEVBNkJYLFdBN0JXLEVBOEJYLFdBOUJXLEVBK0JYLGVBL0JXLEVBZ0NYLGNBaENXLEVBaUNYLGdCQWpDVyxFQWtDWCxhQWxDVyxFQW1DWCxVQW5DVyxFQW9DWCxR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LE9BRks7QUFHWkMsRUFBQUEsUUFBUSxFQUFFLFVBSEU7QUFJWkMsRUFBQUEsUUFBUSxFQUFFO0FBSkUsQ0FBZCxDLENBT0E7O0FBQ0FyRixJQUFJLENBQUNzRixHQUFMLEdBQVc7QUFDVEMsRUFBQUEsT0FBTyxFQUFFLFNBREE7QUFFVEMsRUFBQUEsS0FBSyxFQUFFLE9BRkU7QUFHVEMsRUFBQUEsSUFBSSxFQUFFLE1BSEc7QUFJVEMsRUFBQUEsTUFBTSxFQUFFLFFBSkM7QUFLVEMsRUFBQUEsT0FBTyxFQUFFO0FBTEEsQ0FBWDtBQVFBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI3RixJQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcblxuY29uc3QgRm9ybURhdGEgPSByZXF1aXJlKCdmb3JtLWRhdGEnKTtcbmNvbnN0IEZyaXNiZWUgPSByZXF1aXJlKCdmcmlzYmVlJyk7XG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5jb25zdCBzYWZlU3RyaW5naWZ5ID0gcmVxdWlyZSgnZmFzdC1zYWZlLXN0cmluZ2lmeScpO1xuY29uc3QgdW5pdmVyc2FsaWZ5ID0gcmVxdWlyZSgndW5pdmVyc2FsaWZ5Jyk7XG5jb25zdCB7IGJvb2xlYW4gfSA9IHJlcXVpcmUoJ2Jvb2xlYW4nKTtcblxuLy8gT2JqZWN0LmtleXMocmVxdWlyZSgnc2hhcnAnKS5wcm90b3R5cGUpLmZpbHRlcihrZXkgPT4gIWtleS5zdGFydHNXaXRoKCdfJykpXG5jb25zdCBrZXlzID0gW1xuICAnbWV0YWRhdGEnLFxuICAnbGltaXRJbnB1dFBpeGVscycsXG4gICdzZXF1ZW50aWFsUmVhZCcsXG4gICdyZXNpemUnLFxuICAnY3JvcCcsXG4gICdlbWJlZCcsXG4gICdtYXgnLFxuICAnbWluJyxcbiAgJ2lnbm9yZUFzcGVjdFJhdGlvJyxcbiAgJ3dpdGhvdXRFbmxhcmdlbWVudCcsXG4gICdvdmVybGF5V2l0aCcsXG4gICdyb3RhdGUnLFxuICAnZXh0cmFjdCcsXG4gICdmbGlwJyxcbiAgJ2Zsb3AnLFxuICAnc2hhcnBlbicsXG4gICdibHVyJyxcbiAgJ2V4dGVuZCcsXG4gICdmbGF0dGVuJyxcbiAgJ3RyaW0nLFxuICAnZ2FtbWEnLFxuICAnbmVnYXRlJyxcbiAgJ25vcm1hbGlzZScsXG4gICdub3JtYWxpemUnLFxuICAnY29udm9sdmUnLFxuICAndGhyZXNob2xkJyxcbiAgJ2Jvb2xlYW4nLFxuICAnYmFja2dyb3VuZCcsXG4gICdncmV5c2NhbGUnLFxuICAnZ3JheXNjYWxlJyxcbiAgJ3RvQ29sb3Vyc3BhY2UnLFxuICAndG9Db2xvcnNwYWNlJyxcbiAgJ2V4dHJhY3RDaGFubmVsJyxcbiAgJ2pvaW5DaGFubmVsJyxcbiAgJ2JhbmRib29sJyxcbiAgJ3RvRmlsZScsXG4gICd0b0J1ZmZlcicsXG4gICd3aXRoTWV0YWRhdGEnLFxuICAnanBlZycsXG4gICdwbmcnLFxuICAnd2VicCcsXG4gICd0aWZmJyxcbiAgJ3JhdycsXG4gICd0b0Zvcm1hdCcsXG4gICd0aWxlJ1xuXTtcblxuY2xhc3MgTGlwbyB7XG4gIGNvbnN0cnVjdG9yKGNvbmZpZyA9IHt9KSB7XG4gICAgdGhpcy5fX2NvbmZpZyA9IHtcbiAgICAgIGtleTogcHJvY2Vzcy5lbnYuTElQT19LRVkgfHwgJycsXG4gICAgICBiYXNlVVJJOlxuICAgICAgICBwcm9jZXNzLmVudi5MSVBPID09PSAndHJ1ZSdcbiAgICAgICAgICA/ICdodHRwOi8vbG9jYWxob3N0OjMwMDAnXG4gICAgICAgICAgOiAnaHR0cHM6Ly9hcGkubGlwby5pbycsXG4gICAgICAuLi5jb25maWdcbiAgICB9O1xuXG4gICAgdGhpcy5fX2FwaSA9IG5ldyBGcmlzYmVlKHtcbiAgICAgIGJhc2VVUkk6IHRoaXMuX19jb25maWcuYmFzZVVSSSxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgQWNjZXB0OiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmICh0aGlzLl9fY29uZmlnLmtleSkgdGhpcy5fX2FwaS5hdXRoKHRoaXMuX19jb25maWcua2V5KTtcblxuICAgIHRoaXMuX19xdWV1ZSA9IFtdO1xuXG4gICAgdGhpcy5fX21ldGFkYXRhID0gdW5pdmVyc2FsaWZ5LmZyb21Qcm9taXNlKHRoaXMuX19tZXRhZGF0YSk7XG4gICAgdGhpcy5fX3RvRmlsZSA9IHVuaXZlcnNhbGlmeS5mcm9tUHJvbWlzZSh0aGlzLl9fdG9GaWxlKTtcbiAgICB0aGlzLl9fdG9CdWZmZXIgPSB1bml2ZXJzYWxpZnkuZnJvbVByb21pc2UodGhpcy5fX3RvQnVmZmVyKTtcblxuICAgIHJldHVybiBpbnB1dCA9PiB7XG4gICAgICB0aGlzLl9faW5wdXQgPSBpbnB1dDtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICAvKlxuICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbG92ZWxsL3NoYXJwL2lzc3Vlcy8xMDQ1PlxuICAgIHJldHVybiAoaW5wdXQsIG9wdGlvbnMgPSB7fSkgPT4ge1xuICAgICAgdGhpcy5fX2lucHV0ID0gbnVsbDtcbiAgICAgIHRoaXMuX19vcHRpb25zID0ge307XG4gICAgICAvLyBpbnB1dCA9IEJ1ZmZlciB8IFN0cmluZ1xuICAgICAgLy8gb3B0aW9ucyA9IE9iamVjdFxuICAgICAgLy8gLSBkZW5zaXR5IChOdW1iZXIpXG4gICAgICAvLyAtIHJhdyAoT2JqZWN0KVxuICAgICAgLy8gICAtIHdpZHRoIChOdW1iZXIpXG4gICAgICAvLyAgIC0gaGVpZ2h0IChOdW1iZXIpXG4gICAgICAvLyAgIC0gY2hhbm5lbHMgKE51bWJlcjsgMS00KVxuICAgICAgLy8gLSBjcmVhdGUgKE9iamVjdClcbiAgICAgIC8vICAgLSB3aWR0aCAoTnVtYmVyKVxuICAgICAgLy8gICAtIGhlaWdodCAoTnVtYmVyKVxuICAgICAgLy8gICAtIGNoYW5uZWxzIChOdW1iZXI7IDMtNClcbiAgICAgIC8vICAgLSBiYWNrZ3JvdW5kIChTdHJpbmcgfCBPYmplY3QpXG4gICAgICBpZiAoXy5pc1N0cmluZyhpbnB1dCkgfHwgXy5pc0J1ZmZlcihpbnB1dCkpIHRoaXMuX19pbnB1dCA9IGlucHV0O1xuICAgICAgZWxzZSBpZiAoXy5pc09iamVjdCh0aGlzLl9faW5wdXQpKSB0aGlzLl9fb3B0aW9ucyA9IGlucHV0O1xuICAgICAgaWYgKCFfLmlzT2JqZWN0KHRoaXMuX19pbnB1dCkgJiYgXy5pc09iamVjdChvcHRpb25zKSlcbiAgICAgICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuICAgICovXG4gIH1cblxuICBhc3luYyBfX21ldGFkYXRhKCkge1xuICAgIGNvbnN0IGJvZHkgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBpZiAoXy5pc1N0cmluZyh0aGlzLl9faW5wdXQpKVxuICAgICAgYm9keS5hcHBlbmQoJ2lucHV0JywgZnMuY3JlYXRlUmVhZFN0cmVhbSh0aGlzLl9faW5wdXQpKTtcbiAgICBlbHNlIGlmIChfLmlzQnVmZmVyKHRoaXMuX19pbnB1dCkpIGJvZHkuYXBwZW5kKCdpbnB1dCcsIHRoaXMuX19pbnB1dCk7XG4gICAgZWxzZSBpZiAoXy5pc09iamVjdCh0aGlzLl9faW5wdXQpKVxuICAgICAgYm9keS5hcHBlbmQoJ29wdGlvbnMnLCBzYWZlU3RyaW5naWZ5KHRoaXMuX19pbnB1dCkpO1xuICAgIGJvZHkuYXBwZW5kKCdxdWV1ZScsIHNhZmVTdHJpbmdpZnkodGhpcy5fX3F1ZXVlKSk7XG4gICAgdGhpcy5fX3F1ZXVlID0gW107XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5fX2FwaS5wb3N0KCcvJywgeyBib2R5IH0pO1xuICAgIGlmIChyZXMuZXJyKSB0aHJvdyByZXMuZXJyO1xuICAgIHJldHVybiByZXMuYm9keTtcbiAgfVxuXG4gIGFzeW5jIF9fdG9GaWxlKGZpbGVPdXQpIHtcbiAgICBpZiAoIV8uaXNTdHJpbmcoZmlsZU91dCkpIHRocm93IG5ldyBFcnJvcignRmlsZSBvdXRwdXQgcGF0aCByZXF1aXJlZCcpO1xuICAgIGNvbnN0IGJvZHkgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBpZiAoXy5pc1N0cmluZyh0aGlzLl9faW5wdXQpKVxuICAgICAgYm9keS5hcHBlbmQoJ2lucHV0JywgZnMuY3JlYXRlUmVhZFN0cmVhbSh0aGlzLl9faW5wdXQpKTtcbiAgICBlbHNlIGlmIChfLmlzQnVmZmVyKHRoaXMuX19pbnB1dCkpIGJvZHkuYXBwZW5kKCdpbnB1dCcsIHRoaXMuX19pbnB1dCk7XG4gICAgZWxzZSBpZiAoXy5pc09iamVjdCh0aGlzLl9faW5wdXQpKVxuICAgICAgYm9keS5hcHBlbmQoJ29wdGlvbnMnLCBzYWZlU3RyaW5naWZ5KHRoaXMuX19pbnB1dCkpO1xuICAgIGJvZHkuYXBwZW5kKCdxdWV1ZScsIHNhZmVTdHJpbmdpZnkodGhpcy5fX3F1ZXVlKSk7XG4gICAgdGhpcy5fX3F1ZXVlID0gW107XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5fX2FwaS5wb3N0KCcvJywgeyBib2R5LCByYXc6IHRydWUgfSk7XG4gICAgaWYgKHJlcy5lcnIpIHRocm93IHJlcy5lcnI7XG4gICAgdGhpcy5fX2luZm8gPSB7XG4gICAgICBmb3JtYXQ6IHJlcy5oZWFkZXJzLmdldCgneC1zaGFycC1mb3JtYXQnKSxcbiAgICAgIHNpemU6IE51bWJlcihyZXMuaGVhZGVycy5nZXQoJ3gtc2hhcnAtc2l6ZScpKSxcbiAgICAgIHdpZHRoOiBOdW1iZXIocmVzLmhlYWRlcnMuZ2V0KCd4LXNoYXJwLXdpZHRoJykpLFxuICAgICAgaGVpZ2h0OiBOdW1iZXIocmVzLmhlYWRlcnMuZ2V0KCd4LXNoYXJwLWhlaWdodCcpKSxcbiAgICAgIGNoYW5uZWxzOiBOdW1iZXIocmVzLmhlYWRlcnMuZ2V0KCd4LXNoYXJwLWNoYW5uZWxzJykpLFxuICAgICAgcHJlbXVsdGlwbGllZDogYm9vbGVhbihyZXMuaGVhZGVycy5nZXQoJ3gtc2hhcnAtbXVsdGlwbGllZCcpKVxuICAgIH07XG4gICAgY29uc3Qgc3RyZWFtID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0oZmlsZU91dCk7XG4gICAgLy8gbGV0IHRpbWVyO1xuICAgIC8vIHN0cmVhbS5vbignb3BlbicsICgpID0+IHtcbiAgICAvLyAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgLy8gICAgIHN0cmVhbS5jbG9zZSgpO1xuICAgIC8vICAgICByZWplY3QobmV3IEVycm9yKCdUaW1lZCBvdXQgd2hpbGUgd3JpdGluZyBmaWxlJykpO1xuICAgIC8vICAgfSwgMTAwMDApO1xuICAgIC8vIH0pO1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0KS5vbignZmluaXNoJywgKCkgPT4ge1xuICAgICAgICByZXNvbHZlKHRoaXMuX19pbmZvKTtcbiAgICAgIH0pO1xuICAgICAgcmVzLmJvZHkub24oJ2Vycm9yJywgcmVqZWN0KS5waXBlKHN0cmVhbSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH1cblxuICBhc3luYyBfX3RvQnVmZmVyKG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IGJvZHkgPSBuZXcgRm9ybURhdGEoKTtcbiAgICBpZiAoXy5pc1N0cmluZyh0aGlzLl9faW5wdXQpKVxuICAgICAgYm9keS5hcHBlbmQoJ2lucHV0JywgZnMuY3JlYXRlUmVhZFN0cmVhbSh0aGlzLl9faW5wdXQpKTtcbiAgICBlbHNlIGlmIChfLmlzQnVmZmVyKHRoaXMuX19pbnB1dCkpIGJvZHkuYXBwZW5kKCdpbnB1dCcsIHRoaXMuX19pbnB1dCk7XG4gICAgZWxzZSBpZiAoXy5pc09iamVjdCh0aGlzLl9faW5wdXQpKVxuICAgICAgYm9keS5hcHBlbmQoJ29wdGlvbnMnLCBzYWZlU3RyaW5naWZ5KHRoaXMuX19pbnB1dCkpO1xuICAgIGJvZHkuYXBwZW5kKCdxdWV1ZScsIHNhZmVTdHJpbmdpZnkodGhpcy5fX3F1ZXVlKSk7XG4gICAgdGhpcy5fX3F1ZXVlID0gW107XG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5fX2FwaS5wb3N0KCcvJywgeyBib2R5LCByYXc6IHRydWUgfSk7XG4gICAgaWYgKHJlcy5lcnIpIHRocm93IHJlcy5lcnI7XG4gICAgdGhpcy5fX2luZm8gPSB7XG4gICAgICBmb3JtYXQ6IHJlcy5oZWFkZXJzLmdldCgneC1zaGFycC1mb3JtYXQnKSxcbiAgICAgIHNpemU6IE51bWJlcihyZXMuaGVhZGVycy5nZXQoJ3gtc2hhcnAtc2l6ZScpKSxcbiAgICAgIHdpZHRoOiBOdW1iZXIocmVzLmhlYWRlcnMuZ2V0KCd4LXNoYXJwLXdpZHRoJykpLFxuICAgICAgaGVpZ2h0OiBOdW1iZXIocmVzLmhlYWRlcnMuZ2V0KCd4LXNoYXJwLWhlaWdodCcpKSxcbiAgICAgIGNoYW5uZWxzOiBOdW1iZXIocmVzLmhlYWRlcnMuZ2V0KCd4LXNoYXJwLWNoYW5uZWxzJykpLFxuICAgICAgcHJlbXVsdGlwbGllZDogYm9vbGVhbihyZXMuaGVhZGVycy5nZXQoJ3gtc2hhcnAtbXVsdGlwbGllZCcpKVxuICAgIH07XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5idWZmZXIoKTtcbiAgICBpZiAoXy5pc09iamVjdChvcHRpb25zKSAmJiBib29sZWFuKG9wdGlvbnMucmVzb2x2ZVdpdGhPYmplY3QpKVxuICAgICAgcmV0dXJuIHsgZGF0YSwgaW5mbzogdGhpcy5fX2luZm8gfTtcbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIGNsb25lKCkge1xuICAgIHJldHVybiBuZXcgTGlwbyh7IC4uLnRoaXMuX19jb25maWcgfSkodGhpcy5fX2lucHV0KTtcbiAgfVxufVxuXG5rZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgTGlwby5wcm90b3R5cGVba2V5XSA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHtcbiAgICBpZiAoIVsndG9GaWxlJywgJ3RvQnVmZmVyJywgJ21ldGFkYXRhJ10uaW5jbHVkZXMoa2V5KSkge1xuICAgICAgdGhpcy5fX3F1ZXVlLnB1c2goW2tleV0uY29uY2F0KGFyZ3MpKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGlmIChrZXkgPT09ICdtZXRhZGF0YScpIHtcbiAgICAgIHRoaXMuX19xdWV1ZS5wdXNoKFsnbWV0YWRhdGEnXSk7XG4gICAgICByZXR1cm4gdGhpcy5fX21ldGFkYXRhKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIGlmIChrZXkgPT09ICd0b0ZpbGUnKSByZXR1cm4gdGhpcy5fX3RvRmlsZSguLi5hcmdzKTtcbiAgICByZXR1cm4gdGhpcy5fX3RvQnVmZmVyKC4uLmFyZ3MpO1xuICB9O1xufSk7XG5cbi8vIFNvdXJjZWQgZnJvbSBgbGliL3Jlc2l6ZS5qc2A6XG4vLyA8aHR0cHM6Ly9naXRodWIuY29tL2xvdmVsbC9zaGFycC9ibG9iL21hc3Rlci9saWIvcmVzaXplLmpzPlxuXG4vLyBXZWlnaHRpbmcgdG8gYXBwbHkgd2hlbiB1c2luZyBjb250YWluL2NvdmVyIGZpdC5cbkxpcG8uZ3Jhdml0eSA9IHtcbiAgY2VudGVyOiAwLFxuICBjZW50cmU6IDAsXG4gIG5vcnRoOiAxLFxuICBlYXN0OiAyLFxuICBzb3V0aDogMyxcbiAgd2VzdDogNCxcbiAgbm9ydGhlYXN0OiA1LFxuICBzb3V0aGVhc3Q6IDYsXG4gIHNvdXRod2VzdDogNyxcbiAgbm9ydGh3ZXN0OiA4XG59O1xuXG4vLyBQb3NpdGlvbiB0byBhcHBseSB3aGVuIHVzaW5nIGNvbnRhaW4vY292ZXIgZml0LlxuTGlwby5wb3NpdGlvbiA9IHtcbiAgdG9wOiAxLFxuICByaWdodDogMixcbiAgYm90dG9tOiAzLFxuICBsZWZ0OiA0LFxuICAncmlnaHQgdG9wJzogNSxcbiAgJ3JpZ2h0IGJvdHRvbSc6IDYsXG4gICdsZWZ0IGJvdHRvbSc6IDcsXG4gICdsZWZ0IHRvcCc6IDhcbn07XG5cbi8vIFN0cmF0ZWdpZXMgZm9yIGF1dG9tYWdpYyBjb3ZlciBiZWhhdmlvdXIuXG5MaXBvLnN0cmF0ZWd5ID0ge1xuICBlbnRyb3B5OiAxNixcbiAgYXR0ZW50aW9uOiAxN1xufTtcblxuLy8gUmVkdWN0aW9uIGtlcm5lbHMuXG5MaXBvLmtlcm5lbCA9IHtcbiAgbmVhcmVzdDogJ25lYXJlc3QnLFxuICBjdWJpYzogJ2N1YmljJyxcbiAgbGFuY3pvczI6ICdsYW5jem9zMicsXG4gIGxhbmN6b3MzOiAnbGFuY3pvczMnXG59O1xuXG4vLyBNZXRob2RzIGJ5IHdoaWNoIGFuIGltYWdlIGNhbiBiZSByZXNpemVkIHRvIGZpdCB0aGUgcHJvdmlkZWQgZGltZW5zaW9ucy5cbkxpcG8uZml0ID0ge1xuICBjb250YWluOiAnY29udGFpbicsXG4gIGNvdmVyOiAnY292ZXInLFxuICBmaWxsOiAnZmlsbCcsXG4gIGluc2lkZTogJ2luc2lkZScsXG4gIG91dHNpZGU6ICdvdXRzaWRlJ1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBMaXBvO1xuIl19