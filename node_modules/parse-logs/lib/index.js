"use strict";

const ErrorStackParser = require('error-stack-parser');

const defaultsDeep = require('lodash/defaultsDeep');

const includes = require('lodash/includes');

const isEmpty = require('lodash/isEmpty');

const isError = require('iserror');

const isObject = require('lodash/isObject');

const isString = require('lodash/isString');

const isWhitespace = require('is-whitespace');

const parseRequest = require('parse-request');

const pick = require('lodash/pick');

const prepareStackTrace = require('prepare-stack-trace');

const rfdc = require('rfdc');

const clone = rfdc();
const levels = ['trace', 'debug', 'info', 'warn', 'error', 'fatal']; // req = ctx.request (Koa)
// req = req (Express)
// eslint-disable-next-line complexity

const parseLogs = (req, userFields = ['ip_address'], allowEmpty = false) => {
  // ensure that `req` is an object
  if (!isObject(req)) throw new Error('Request object was missing or not an object');
  const isBodyAnObject = isObject(req.body); // ensure that a 'body' exists in the request

  if (!allowEmpty && !isBodyAnObject) throw new Error('Log request is missing parsed `body` object property'); // parse the request body for `message` and `meta` object

  const log = {};

  if (isBodyAnObject) {
    if (isString(req.body.message) && !isWhitespace(req.body.message)) log.message = clone(req.body.message);
    if (isObject(req.body.meta) && !isEmpty(req.body.meta)) log.meta = clone(req.body.meta);
  } // ensure that we have something sent from the client otherwise throw error


  if (!allowEmpty && isEmpty(log)) throw new Error('Log is missing `message` and/or `meta` properties (at least one is required)'); // if `log.meta` is not an object then make it one

  if (!isObject(log.meta)) log.meta = {}; // parse the request (will populate user and IP if they do not already exist)

  log.meta = defaultsDeep(log.meta, parseRequest({
    req,
    userFields
  })); // parse the app info

  if (isObject(log.meta.app)) log.meta.app = pick(log.meta.app, ['name', 'version', 'node', 'hash', 'tag', 'environment', 'hostname', 'pid']); // ensure log level is a String if it was passed in request

  if (!allowEmpty && !isString(log.meta.level)) throw new Error('Log meta `level` must be a String'); // ensure it is a valid log level

  if (!allowEmpty && !includes(levels, log.meta.level)) throw new Error(`Log \`level\` of "${log.meta.level}" was invalid, it must be one of: ${levels.join(', ')}`); // TODO: if there was a `log.meta.user` property
  // parse the error if it has one

  if (isObject(log.meta) && isObject(log.meta.err) && isString(log.meta.err.message) && !isError(log.meta.err)) {
    try {
      const err = new Error(log.meta.err.message);
      const stack = err.stack;

      for (const prop in log.meta.err) {
        if (Object.prototype.hasOwnProperty.call(log.meta.err, prop)) err[prop] = log.meta.err[prop];
      }

      if (!err.name && err.constructor.name) err.name = err.constructor.name; // <https://github.com/tjmehta/error-to-json/blob/master/index.js#L46-L55>

      if (err.stack === stack) err.stack = stack.slice(0, stack.indexOf('\n')); //
      // Note we could use `stackTrace.parse(err)`
      // however we shouldn't assume that everyone
      // will be sending us Node-like stack traces
      // (e.g. ones converted using StackTrace.JS `fromError`)
      //
      // const stackTrace = require('stack-trace');
      //

      err.stack = prepareStackTrace(err, ErrorStackParser.parse(err));
      log.meta.err = err;
    } catch (err) {
      log.meta.original_err = log.meta.err;
      log.meta.err = err;
    }
  } // return the log


  return log;
};

module.exports = parseLogs;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJFcnJvclN0YWNrUGFyc2VyIiwicmVxdWlyZSIsImRlZmF1bHRzRGVlcCIsImluY2x1ZGVzIiwiaXNFbXB0eSIsImlzRXJyb3IiLCJpc09iamVjdCIsImlzU3RyaW5nIiwiaXNXaGl0ZXNwYWNlIiwicGFyc2VSZXF1ZXN0IiwicGljayIsInByZXBhcmVTdGFja1RyYWNlIiwicmZkYyIsImNsb25lIiwibGV2ZWxzIiwicGFyc2VMb2dzIiwicmVxIiwidXNlckZpZWxkcyIsImFsbG93RW1wdHkiLCJFcnJvciIsImlzQm9keUFuT2JqZWN0IiwiYm9keSIsImxvZyIsIm1lc3NhZ2UiLCJtZXRhIiwiYXBwIiwibGV2ZWwiLCJqb2luIiwiZXJyIiwic3RhY2siLCJwcm9wIiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwibmFtZSIsImNvbnN0cnVjdG9yIiwic2xpY2UiLCJpbmRleE9mIiwicGFyc2UiLCJvcmlnaW5hbF9lcnIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLGdCQUFnQixHQUFHQyxPQUFPLENBQUMsb0JBQUQsQ0FBaEM7O0FBQ0EsTUFBTUMsWUFBWSxHQUFHRCxPQUFPLENBQUMscUJBQUQsQ0FBNUI7O0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsaUJBQUQsQ0FBeEI7O0FBQ0EsTUFBTUcsT0FBTyxHQUFHSCxPQUFPLENBQUMsZ0JBQUQsQ0FBdkI7O0FBQ0EsTUFBTUksT0FBTyxHQUFHSixPQUFPLENBQUMsU0FBRCxDQUF2Qjs7QUFDQSxNQUFNSyxRQUFRLEdBQUdMLE9BQU8sQ0FBQyxpQkFBRCxDQUF4Qjs7QUFDQSxNQUFNTSxRQUFRLEdBQUdOLE9BQU8sQ0FBQyxpQkFBRCxDQUF4Qjs7QUFDQSxNQUFNTyxZQUFZLEdBQUdQLE9BQU8sQ0FBQyxlQUFELENBQTVCOztBQUNBLE1BQU1RLFlBQVksR0FBR1IsT0FBTyxDQUFDLGVBQUQsQ0FBNUI7O0FBQ0EsTUFBTVMsSUFBSSxHQUFHVCxPQUFPLENBQUMsYUFBRCxDQUFwQjs7QUFDQSxNQUFNVSxpQkFBaUIsR0FBR1YsT0FBTyxDQUFDLHFCQUFELENBQWpDOztBQUNBLE1BQU1XLElBQUksR0FBR1gsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBRUEsTUFBTVksS0FBSyxHQUFHRCxJQUFJLEVBQWxCO0FBRUEsTUFBTUUsTUFBTSxHQUFHLENBQUMsT0FBRCxFQUFVLE9BQVYsRUFBbUIsTUFBbkIsRUFBMkIsTUFBM0IsRUFBbUMsT0FBbkMsRUFBNEMsT0FBNUMsQ0FBZixDLENBRUE7QUFDQTtBQUNBOztBQUNBLE1BQU1DLFNBQVMsR0FBRyxDQUFDQyxHQUFELEVBQU1DLFVBQVUsR0FBRyxDQUFDLFlBQUQsQ0FBbkIsRUFBbUNDLFVBQVUsR0FBRyxLQUFoRCxLQUEwRDtBQUMxRTtBQUNBLE1BQUksQ0FBQ1osUUFBUSxDQUFDVSxHQUFELENBQWIsRUFDRSxNQUFNLElBQUlHLEtBQUosQ0FBVSw2Q0FBVixDQUFOO0FBRUYsUUFBTUMsY0FBYyxHQUFHZCxRQUFRLENBQUNVLEdBQUcsQ0FBQ0ssSUFBTCxDQUEvQixDQUwwRSxDQU8xRTs7QUFDQSxNQUFJLENBQUNILFVBQUQsSUFBZSxDQUFDRSxjQUFwQixFQUNFLE1BQU0sSUFBSUQsS0FBSixDQUFVLHNEQUFWLENBQU4sQ0FUd0UsQ0FXMUU7O0FBQ0EsUUFBTUcsR0FBRyxHQUFHLEVBQVo7O0FBQ0EsTUFBSUYsY0FBSixFQUFvQjtBQUNsQixRQUFJYixRQUFRLENBQUNTLEdBQUcsQ0FBQ0ssSUFBSixDQUFTRSxPQUFWLENBQVIsSUFBOEIsQ0FBQ2YsWUFBWSxDQUFDUSxHQUFHLENBQUNLLElBQUosQ0FBU0UsT0FBVixDQUEvQyxFQUNFRCxHQUFHLENBQUNDLE9BQUosR0FBY1YsS0FBSyxDQUFDRyxHQUFHLENBQUNLLElBQUosQ0FBU0UsT0FBVixDQUFuQjtBQUNGLFFBQUlqQixRQUFRLENBQUNVLEdBQUcsQ0FBQ0ssSUFBSixDQUFTRyxJQUFWLENBQVIsSUFBMkIsQ0FBQ3BCLE9BQU8sQ0FBQ1ksR0FBRyxDQUFDSyxJQUFKLENBQVNHLElBQVYsQ0FBdkMsRUFDRUYsR0FBRyxDQUFDRSxJQUFKLEdBQVdYLEtBQUssQ0FBQ0csR0FBRyxDQUFDSyxJQUFKLENBQVNHLElBQVYsQ0FBaEI7QUFDSCxHQWxCeUUsQ0FvQjFFOzs7QUFDQSxNQUFJLENBQUNOLFVBQUQsSUFBZWQsT0FBTyxDQUFDa0IsR0FBRCxDQUExQixFQUNFLE1BQU0sSUFBSUgsS0FBSixDQUNKLDhFQURJLENBQU4sQ0F0QndFLENBMEIxRTs7QUFDQSxNQUFJLENBQUNiLFFBQVEsQ0FBQ2dCLEdBQUcsQ0FBQ0UsSUFBTCxDQUFiLEVBQXlCRixHQUFHLENBQUNFLElBQUosR0FBVyxFQUFYLENBM0JpRCxDQTZCMUU7O0FBQ0FGLEVBQUFBLEdBQUcsQ0FBQ0UsSUFBSixHQUFXdEIsWUFBWSxDQUFDb0IsR0FBRyxDQUFDRSxJQUFMLEVBQVdmLFlBQVksQ0FBQztBQUFFTyxJQUFBQSxHQUFGO0FBQU9DLElBQUFBO0FBQVAsR0FBRCxDQUF2QixDQUF2QixDQTlCMEUsQ0FnQzFFOztBQUNBLE1BQUlYLFFBQVEsQ0FBQ2dCLEdBQUcsQ0FBQ0UsSUFBSixDQUFTQyxHQUFWLENBQVosRUFDRUgsR0FBRyxDQUFDRSxJQUFKLENBQVNDLEdBQVQsR0FBZWYsSUFBSSxDQUFDWSxHQUFHLENBQUNFLElBQUosQ0FBU0MsR0FBVixFQUFlLENBQ2hDLE1BRGdDLEVBRWhDLFNBRmdDLEVBR2hDLE1BSGdDLEVBSWhDLE1BSmdDLEVBS2hDLEtBTGdDLEVBTWhDLGFBTmdDLEVBT2hDLFVBUGdDLEVBUWhDLEtBUmdDLENBQWYsQ0FBbkIsQ0FsQ3dFLENBNkMxRTs7QUFDQSxNQUFJLENBQUNQLFVBQUQsSUFBZSxDQUFDWCxRQUFRLENBQUNlLEdBQUcsQ0FBQ0UsSUFBSixDQUFTRSxLQUFWLENBQTVCLEVBQ0UsTUFBTSxJQUFJUCxLQUFKLENBQVUsbUNBQVYsQ0FBTixDQS9Dd0UsQ0FpRDFFOztBQUNBLE1BQUksQ0FBQ0QsVUFBRCxJQUFlLENBQUNmLFFBQVEsQ0FBQ1csTUFBRCxFQUFTUSxHQUFHLENBQUNFLElBQUosQ0FBU0UsS0FBbEIsQ0FBNUIsRUFDRSxNQUFNLElBQUlQLEtBQUosQ0FDSCxxQkFDQ0csR0FBRyxDQUFDRSxJQUFKLENBQVNFLEtBQ1YscUNBQW9DWixNQUFNLENBQUNhLElBQVAsQ0FBWSxJQUFaLENBQWtCLEVBSG5ELENBQU4sQ0FuRHdFLENBeUQxRTtBQUVBOztBQUNBLE1BQ0VyQixRQUFRLENBQUNnQixHQUFHLENBQUNFLElBQUwsQ0FBUixJQUNBbEIsUUFBUSxDQUFDZ0IsR0FBRyxDQUFDRSxJQUFKLENBQVNJLEdBQVYsQ0FEUixJQUVBckIsUUFBUSxDQUFDZSxHQUFHLENBQUNFLElBQUosQ0FBU0ksR0FBVCxDQUFhTCxPQUFkLENBRlIsSUFHQSxDQUFDbEIsT0FBTyxDQUFDaUIsR0FBRyxDQUFDRSxJQUFKLENBQVNJLEdBQVYsQ0FKVixFQUtFO0FBQ0EsUUFBSTtBQUNGLFlBQU1BLEdBQUcsR0FBRyxJQUFJVCxLQUFKLENBQVVHLEdBQUcsQ0FBQ0UsSUFBSixDQUFTSSxHQUFULENBQWFMLE9BQXZCLENBQVo7QUFERSxZQUVNTSxLQUZOLEdBRWdCRCxHQUZoQixDQUVNQyxLQUZOOztBQUdGLFdBQUssTUFBTUMsSUFBWCxJQUFtQlIsR0FBRyxDQUFDRSxJQUFKLENBQVNJLEdBQTVCLEVBQWlDO0FBQy9CLFlBQUlHLE1BQU0sQ0FBQ0MsU0FBUCxDQUFpQkMsY0FBakIsQ0FBZ0NDLElBQWhDLENBQXFDWixHQUFHLENBQUNFLElBQUosQ0FBU0ksR0FBOUMsRUFBbURFLElBQW5ELENBQUosRUFDRUYsR0FBRyxDQUFDRSxJQUFELENBQUgsR0FBWVIsR0FBRyxDQUFDRSxJQUFKLENBQVNJLEdBQVQsQ0FBYUUsSUFBYixDQUFaO0FBQ0g7O0FBRUQsVUFBSSxDQUFDRixHQUFHLENBQUNPLElBQUwsSUFBYVAsR0FBRyxDQUFDUSxXQUFKLENBQWdCRCxJQUFqQyxFQUF1Q1AsR0FBRyxDQUFDTyxJQUFKLEdBQVdQLEdBQUcsQ0FBQ1EsV0FBSixDQUFnQkQsSUFBM0IsQ0FSckMsQ0FTRjs7QUFDQSxVQUFJUCxHQUFHLENBQUNDLEtBQUosS0FBY0EsS0FBbEIsRUFBeUJELEdBQUcsQ0FBQ0MsS0FBSixHQUFZQSxLQUFLLENBQUNRLEtBQU4sQ0FBWSxDQUFaLEVBQWVSLEtBQUssQ0FBQ1MsT0FBTixDQUFjLElBQWQsQ0FBZixDQUFaLENBVnZCLENBV0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDQVYsTUFBQUEsR0FBRyxDQUFDQyxLQUFKLEdBQVlsQixpQkFBaUIsQ0FBQ2lCLEdBQUQsRUFBTTVCLGdCQUFnQixDQUFDdUMsS0FBakIsQ0FBdUJYLEdBQXZCLENBQU4sQ0FBN0I7QUFDQU4sTUFBQUEsR0FBRyxDQUFDRSxJQUFKLENBQVNJLEdBQVQsR0FBZUEsR0FBZjtBQUNELEtBckJELENBcUJFLE9BQU9BLEdBQVAsRUFBWTtBQUNaTixNQUFBQSxHQUFHLENBQUNFLElBQUosQ0FBU2dCLFlBQVQsR0FBd0JsQixHQUFHLENBQUNFLElBQUosQ0FBU0ksR0FBakM7QUFDQU4sTUFBQUEsR0FBRyxDQUFDRSxJQUFKLENBQVNJLEdBQVQsR0FBZUEsR0FBZjtBQUNEO0FBQ0YsR0EzRnlFLENBNkYxRTs7O0FBQ0EsU0FBT04sR0FBUDtBQUNELENBL0ZEOztBQWlHQW1CLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjNCLFNBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgRXJyb3JTdGFja1BhcnNlciA9IHJlcXVpcmUoJ2Vycm9yLXN0YWNrLXBhcnNlcicpO1xuY29uc3QgZGVmYXVsdHNEZWVwID0gcmVxdWlyZSgnbG9kYXNoL2RlZmF1bHRzRGVlcCcpO1xuY29uc3QgaW5jbHVkZXMgPSByZXF1aXJlKCdsb2Rhc2gvaW5jbHVkZXMnKTtcbmNvbnN0IGlzRW1wdHkgPSByZXF1aXJlKCdsb2Rhc2gvaXNFbXB0eScpO1xuY29uc3QgaXNFcnJvciA9IHJlcXVpcmUoJ2lzZXJyb3InKTtcbmNvbnN0IGlzT2JqZWN0ID0gcmVxdWlyZSgnbG9kYXNoL2lzT2JqZWN0Jyk7XG5jb25zdCBpc1N0cmluZyA9IHJlcXVpcmUoJ2xvZGFzaC9pc1N0cmluZycpO1xuY29uc3QgaXNXaGl0ZXNwYWNlID0gcmVxdWlyZSgnaXMtd2hpdGVzcGFjZScpO1xuY29uc3QgcGFyc2VSZXF1ZXN0ID0gcmVxdWlyZSgncGFyc2UtcmVxdWVzdCcpO1xuY29uc3QgcGljayA9IHJlcXVpcmUoJ2xvZGFzaC9waWNrJyk7XG5jb25zdCBwcmVwYXJlU3RhY2tUcmFjZSA9IHJlcXVpcmUoJ3ByZXBhcmUtc3RhY2stdHJhY2UnKTtcbmNvbnN0IHJmZGMgPSByZXF1aXJlKCdyZmRjJyk7XG5cbmNvbnN0IGNsb25lID0gcmZkYygpO1xuXG5jb25zdCBsZXZlbHMgPSBbJ3RyYWNlJywgJ2RlYnVnJywgJ2luZm8nLCAnd2FybicsICdlcnJvcicsICdmYXRhbCddO1xuXG4vLyByZXEgPSBjdHgucmVxdWVzdCAoS29hKVxuLy8gcmVxID0gcmVxIChFeHByZXNzKVxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBsZXhpdHlcbmNvbnN0IHBhcnNlTG9ncyA9IChyZXEsIHVzZXJGaWVsZHMgPSBbJ2lwX2FkZHJlc3MnXSwgYWxsb3dFbXB0eSA9IGZhbHNlKSA9PiB7XG4gIC8vIGVuc3VyZSB0aGF0IGByZXFgIGlzIGFuIG9iamVjdFxuICBpZiAoIWlzT2JqZWN0KHJlcSkpXG4gICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IG9iamVjdCB3YXMgbWlzc2luZyBvciBub3QgYW4gb2JqZWN0Jyk7XG5cbiAgY29uc3QgaXNCb2R5QW5PYmplY3QgPSBpc09iamVjdChyZXEuYm9keSk7XG5cbiAgLy8gZW5zdXJlIHRoYXQgYSAnYm9keScgZXhpc3RzIGluIHRoZSByZXF1ZXN0XG4gIGlmICghYWxsb3dFbXB0eSAmJiAhaXNCb2R5QW5PYmplY3QpXG4gICAgdGhyb3cgbmV3IEVycm9yKCdMb2cgcmVxdWVzdCBpcyBtaXNzaW5nIHBhcnNlZCBgYm9keWAgb2JqZWN0IHByb3BlcnR5Jyk7XG5cbiAgLy8gcGFyc2UgdGhlIHJlcXVlc3QgYm9keSBmb3IgYG1lc3NhZ2VgIGFuZCBgbWV0YWAgb2JqZWN0XG4gIGNvbnN0IGxvZyA9IHt9O1xuICBpZiAoaXNCb2R5QW5PYmplY3QpIHtcbiAgICBpZiAoaXNTdHJpbmcocmVxLmJvZHkubWVzc2FnZSkgJiYgIWlzV2hpdGVzcGFjZShyZXEuYm9keS5tZXNzYWdlKSlcbiAgICAgIGxvZy5tZXNzYWdlID0gY2xvbmUocmVxLmJvZHkubWVzc2FnZSk7XG4gICAgaWYgKGlzT2JqZWN0KHJlcS5ib2R5Lm1ldGEpICYmICFpc0VtcHR5KHJlcS5ib2R5Lm1ldGEpKVxuICAgICAgbG9nLm1ldGEgPSBjbG9uZShyZXEuYm9keS5tZXRhKTtcbiAgfVxuXG4gIC8vIGVuc3VyZSB0aGF0IHdlIGhhdmUgc29tZXRoaW5nIHNlbnQgZnJvbSB0aGUgY2xpZW50IG90aGVyd2lzZSB0aHJvdyBlcnJvclxuICBpZiAoIWFsbG93RW1wdHkgJiYgaXNFbXB0eShsb2cpKVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdMb2cgaXMgbWlzc2luZyBgbWVzc2FnZWAgYW5kL29yIGBtZXRhYCBwcm9wZXJ0aWVzIChhdCBsZWFzdCBvbmUgaXMgcmVxdWlyZWQpJ1xuICAgICk7XG5cbiAgLy8gaWYgYGxvZy5tZXRhYCBpcyBub3QgYW4gb2JqZWN0IHRoZW4gbWFrZSBpdCBvbmVcbiAgaWYgKCFpc09iamVjdChsb2cubWV0YSkpIGxvZy5tZXRhID0ge307XG5cbiAgLy8gcGFyc2UgdGhlIHJlcXVlc3QgKHdpbGwgcG9wdWxhdGUgdXNlciBhbmQgSVAgaWYgdGhleSBkbyBub3QgYWxyZWFkeSBleGlzdClcbiAgbG9nLm1ldGEgPSBkZWZhdWx0c0RlZXAobG9nLm1ldGEsIHBhcnNlUmVxdWVzdCh7IHJlcSwgdXNlckZpZWxkcyB9KSk7XG5cbiAgLy8gcGFyc2UgdGhlIGFwcCBpbmZvXG4gIGlmIChpc09iamVjdChsb2cubWV0YS5hcHApKVxuICAgIGxvZy5tZXRhLmFwcCA9IHBpY2sobG9nLm1ldGEuYXBwLCBbXG4gICAgICAnbmFtZScsXG4gICAgICAndmVyc2lvbicsXG4gICAgICAnbm9kZScsXG4gICAgICAnaGFzaCcsXG4gICAgICAndGFnJyxcbiAgICAgICdlbnZpcm9ubWVudCcsXG4gICAgICAnaG9zdG5hbWUnLFxuICAgICAgJ3BpZCdcbiAgICBdKTtcblxuICAvLyBlbnN1cmUgbG9nIGxldmVsIGlzIGEgU3RyaW5nIGlmIGl0IHdhcyBwYXNzZWQgaW4gcmVxdWVzdFxuICBpZiAoIWFsbG93RW1wdHkgJiYgIWlzU3RyaW5nKGxvZy5tZXRhLmxldmVsKSlcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0xvZyBtZXRhIGBsZXZlbGAgbXVzdCBiZSBhIFN0cmluZycpO1xuXG4gIC8vIGVuc3VyZSBpdCBpcyBhIHZhbGlkIGxvZyBsZXZlbFxuICBpZiAoIWFsbG93RW1wdHkgJiYgIWluY2x1ZGVzKGxldmVscywgbG9nLm1ldGEubGV2ZWwpKVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgIGBMb2cgXFxgbGV2ZWxcXGAgb2YgXCIke1xuICAgICAgICBsb2cubWV0YS5sZXZlbFxuICAgICAgfVwiIHdhcyBpbnZhbGlkLCBpdCBtdXN0IGJlIG9uZSBvZjogJHtsZXZlbHMuam9pbignLCAnKX1gXG4gICAgKTtcblxuICAvLyBUT0RPOiBpZiB0aGVyZSB3YXMgYSBgbG9nLm1ldGEudXNlcmAgcHJvcGVydHlcblxuICAvLyBwYXJzZSB0aGUgZXJyb3IgaWYgaXQgaGFzIG9uZVxuICBpZiAoXG4gICAgaXNPYmplY3QobG9nLm1ldGEpICYmXG4gICAgaXNPYmplY3QobG9nLm1ldGEuZXJyKSAmJlxuICAgIGlzU3RyaW5nKGxvZy5tZXRhLmVyci5tZXNzYWdlKSAmJlxuICAgICFpc0Vycm9yKGxvZy5tZXRhLmVycilcbiAgKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihsb2cubWV0YS5lcnIubWVzc2FnZSk7XG4gICAgICBjb25zdCB7IHN0YWNrIH0gPSBlcnI7XG4gICAgICBmb3IgKGNvbnN0IHByb3AgaW4gbG9nLm1ldGEuZXJyKSB7XG4gICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobG9nLm1ldGEuZXJyLCBwcm9wKSlcbiAgICAgICAgICBlcnJbcHJvcF0gPSBsb2cubWV0YS5lcnJbcHJvcF07XG4gICAgICB9XG5cbiAgICAgIGlmICghZXJyLm5hbWUgJiYgZXJyLmNvbnN0cnVjdG9yLm5hbWUpIGVyci5uYW1lID0gZXJyLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL3RqbWVodGEvZXJyb3ItdG8tanNvbi9ibG9iL21hc3Rlci9pbmRleC5qcyNMNDYtTDU1PlxuICAgICAgaWYgKGVyci5zdGFjayA9PT0gc3RhY2spIGVyci5zdGFjayA9IHN0YWNrLnNsaWNlKDAsIHN0YWNrLmluZGV4T2YoJ1xcbicpKTtcbiAgICAgIC8vXG4gICAgICAvLyBOb3RlIHdlIGNvdWxkIHVzZSBgc3RhY2tUcmFjZS5wYXJzZShlcnIpYFxuICAgICAgLy8gaG93ZXZlciB3ZSBzaG91bGRuJ3QgYXNzdW1lIHRoYXQgZXZlcnlvbmVcbiAgICAgIC8vIHdpbGwgYmUgc2VuZGluZyB1cyBOb2RlLWxpa2Ugc3RhY2sgdHJhY2VzXG4gICAgICAvLyAoZS5nLiBvbmVzIGNvbnZlcnRlZCB1c2luZyBTdGFja1RyYWNlLkpTIGBmcm9tRXJyb3JgKVxuICAgICAgLy9cbiAgICAgIC8vIGNvbnN0IHN0YWNrVHJhY2UgPSByZXF1aXJlKCdzdGFjay10cmFjZScpO1xuICAgICAgLy9cbiAgICAgIGVyci5zdGFjayA9IHByZXBhcmVTdGFja1RyYWNlKGVyciwgRXJyb3JTdGFja1BhcnNlci5wYXJzZShlcnIpKTtcbiAgICAgIGxvZy5tZXRhLmVyciA9IGVycjtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5tZXRhLm9yaWdpbmFsX2VyciA9IGxvZy5tZXRhLmVycjtcbiAgICAgIGxvZy5tZXRhLmVyciA9IGVycjtcbiAgICB9XG4gIH1cblxuICAvLyByZXR1cm4gdGhlIGxvZ1xuICByZXR1cm4gbG9nO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBwYXJzZUxvZ3M7XG4iXX0=