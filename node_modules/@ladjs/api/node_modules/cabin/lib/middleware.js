"use strict";

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && Symbol.iterator in Object(iter)) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

var onFinished = require('on-finished');

var parseRequest = require('parse-request');

var _require = require('./utils'),
    isFunction = _require.isFunction,
    isUndefined = _require.isUndefined;

module.exports = function () {
  var _this = this;

  for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
    args[_key] = arguments[_key];
  }

  var isExpress = !isUndefined(args[2]) && isFunction(args[2]);
  var req = isExpress ? args[0] : args[0].req;
  var res = isExpress ? args[1] : args[0].res; // const request = isExpress ? args[0] : args[0].request;
  // const response = isExpress ? args[1] : args[0].response;

  var ctx = args[0];
  var next = isExpress ? args[2] : args[1];
  var logger = {}; //
  // Note that `params` is not named `args` because ESLint doesn't warn:
  // <https://github.com/eslint/eslint/issues/11915>
  //

  Object.keys(this.logger).filter(function (key) {
    return isFunction(_this.logger[key]);
  }).forEach(function (key) {
    logger[key] = function () {
      var _this$logger;

      for (var _len2 = arguments.length, params = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        params[_key2] = arguments[_key2];
      }

      if (isUndefined(params[1])) params[1] = {};else params[1] = _this.parseArg(params[1]); // add `request` object to metadata

      Object.assign(params[1], parseRequest(Object.assign(isExpress ? {
        req: req
      } : {
        ctx: ctx
      }, //
      // this symbol was not added until Node v7.7.0
      // and we try to support Node v6.4+
      // <https://github.com/nodejs/node/issues/17745>
      //
      // <https://github.com/nodejs/node/blob/v7.10.0/lib/_http_outgoing.js#L379-L380>
      // <https://github.com/nodejs/node/blob/v7.7.0/lib/_http_outgoing.js#L379-L380>
      // <https://github.com/nodejs/node/blob/v6.4.0/lib/_http_outgoing.js#L351-L352>
      //
      // Note that for the fallback `_headers` all the keys are lowercased
      //
      // But note that in node v12.4.0 for instance this prop is deprecated
      // <https://github.com/nodejs/node/blob/v12.4.0/lib/_http_outgoing.js#L116>
      // So we are left with either the Symbol or use of `getHeaders`
      //
      // HOWEVER automatic properties like Date header aren't
      // set when you do `getHeaders`, they are only written to `_header`
      // and so we need `parse-request` to parse the `responseHeaders`
      // as a String using `http-headers`...
      // <https://github.com/nodejs/node/issues/28302>
      //
      // note that HTTP2 responses do not have a String value
      // for `res._header`, and instead is a Boolean value
      // <https://github.com/nodejs/node/issues/30894>
      // <https://github.com/cabinjs/cabin/issues/133>
      {
        responseHeaders: typeof res._header === 'string' ? res._header : typeof res.getHeaders === 'function' ? res.getHeaders() : null
      }, _this.config.parseRequest)));
      return (_this$logger = _this.logger)[key].apply(_this$logger, _toConsumableArray([].slice.call(params)));
    };
  }); // upon completion of a response we need to log it

  onFinished(res, function (err) {
    if (err) logger.error(err);
    var level = 'info';
    if (res.statusCode >= 500) level = 'error';else if (res.statusCode >= 400) level = 'warn';

    var message = _this.config.message(Object.assign({
      level: level,
      req: req,
      res: res
    }, isExpress ? {} : {
      ctx: args[0]
    }));

    if (err) logger[level](message, {
      err: err
    });else logger[level](message);
  }); // add `log` (shorthand) and `logger` methods
  // `req.log`
  // `res.log`
  // `ctx.req`
  // `ctx.res`
  // `ctx.request`
  // `ctx.response`
  // <https://github.com/pinojs/koa-pino-logger/issues/14>
  // <https://github.com/pinojs/koa-pino-logger/blob/master/logger.js#L11>
  // <https://github.com/pinojs/pino-http/blob/master/logger.js#L55>

  if (isExpress) {
    req.log = logger;
    res.log = logger;
    req.logger = logger;
    res.logger = logger;
  } else {
    var _ctx = args[0];
    _ctx.log = logger;
    _ctx.logger = logger;
    _ctx.request.log = logger;
    _ctx.request.logger = logger;
    _ctx.response.log = logger;
    _ctx.response.logger = logger;
  }

  return next();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9taWRkbGV3YXJlLmpzIl0sIm5hbWVzIjpbIm9uRmluaXNoZWQiLCJyZXF1aXJlIiwicGFyc2VSZXF1ZXN0IiwiaXNGdW5jdGlvbiIsImlzVW5kZWZpbmVkIiwibW9kdWxlIiwiZXhwb3J0cyIsImFyZ3MiLCJpc0V4cHJlc3MiLCJyZXEiLCJyZXMiLCJjdHgiLCJuZXh0IiwibG9nZ2VyIiwiT2JqZWN0Iiwia2V5cyIsImZpbHRlciIsImtleSIsImZvckVhY2giLCJwYXJhbXMiLCJwYXJzZUFyZyIsImFzc2lnbiIsInJlc3BvbnNlSGVhZGVycyIsIl9oZWFkZXIiLCJnZXRIZWFkZXJzIiwiY29uZmlnIiwic2xpY2UiLCJjYWxsIiwiZXJyIiwiZXJyb3IiLCJsZXZlbCIsInN0YXR1c0NvZGUiLCJtZXNzYWdlIiwibG9nIiwicmVxdWVzdCIsInJlc3BvbnNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLElBQU1BLFVBQVUsR0FBR0MsT0FBTyxDQUFDLGFBQUQsQ0FBMUI7O0FBQ0EsSUFBTUMsWUFBWSxHQUFHRCxPQUFPLENBQUMsZUFBRCxDQUE1Qjs7ZUFDb0NBLE9BQU8sQ0FBQyxTQUFELEM7SUFBbkNFLFUsWUFBQUEsVTtJQUFZQyxXLFlBQUFBLFc7O0FBRXBCQyxNQUFNLENBQUNDLE9BQVAsR0FBaUIsWUFBa0I7QUFBQTs7QUFBQSxvQ0FBTkMsSUFBTTtBQUFOQSxJQUFBQSxJQUFNO0FBQUE7O0FBQ2pDLE1BQU1DLFNBQVMsR0FBRyxDQUFDSixXQUFXLENBQUNHLElBQUksQ0FBQyxDQUFELENBQUwsQ0FBWixJQUF5QkosVUFBVSxDQUFDSSxJQUFJLENBQUMsQ0FBRCxDQUFMLENBQXJEO0FBQ0EsTUFBTUUsR0FBRyxHQUFHRCxTQUFTLEdBQUdELElBQUksQ0FBQyxDQUFELENBQVAsR0FBYUEsSUFBSSxDQUFDLENBQUQsQ0FBSixDQUFRRSxHQUExQztBQUNBLE1BQU1DLEdBQUcsR0FBR0YsU0FBUyxHQUFHRCxJQUFJLENBQUMsQ0FB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dCBwYXJzZVJlcXVlc3QgPSByZXF1aXJlKCdwYXJzZS1yZXF1ZXN0Jyk7XG5jb25zdCB7IGlzRnVuY3Rpb24sIGlzVW5kZWZpbmVkIH0gPSByZXF1aXJlKCcuL3V0aWxzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oLi4uYXJncykge1xuICBjb25zdCBpc0V4cHJlc3MgPSAhaXNVbmRlZmluZWQoYXJnc1syXSkgJiYgaXNGdW5jdGlvbihhcmdzWzJdKTtcbiAgY29uc3QgcmVxID0gaXNFeHByZXNzID8gYXJnc1swXSA6IGFyZ3NbMF0ucmVxO1xuICBjb25zdCByZXMgPSBpc0V4cHJlc3MgPyBhcmdzWzFdIDogYXJnc1swXS5yZXM7XG4gIC8vIGNvbnN0IHJlcXVlc3QgPSBpc0V4cHJlc3MgPyBhcmdzWzBdIDogYXJnc1swXS5yZXF1ZXN0O1xuICAvLyBjb25zdCByZXNwb25zZSA9IGlzRXhwcmVzcyA/IGFyZ3NbMV0gOiBhcmdzWzBdLnJlc3BvbnNlO1xuICBjb25zdCBjdHggPSBhcmdzWzBdO1xuICBjb25zdCBuZXh0ID0gaXNFeHByZXNzID8gYXJnc1syXSA6IGFyZ3NbMV07XG4gIGNvbnN0IGxvZ2dlciA9IHt9O1xuICAvL1xuICAvLyBOb3RlIHRoYXQgYHBhcmFtc2AgaXMgbm90IG5hbWVkIGBhcmdzYCBiZWNhdXNlIEVTTGludCBkb2Vzbid0IHdhcm46XG4gIC8vIDxodHRwczovL2dpdGh1Yi5jb20vZXNsaW50L2VzbGludC9pc3N1ZXMvMTE5MTU+XG4gIC8vXG4gIE9iamVjdC5rZXlzKHRoaXMubG9nZ2VyKVxuICAgIC5maWx0ZXIoa2V5ID0+IGlzRnVuY3Rpb24odGhpcy5sb2dnZXJba2V5XSkpXG4gICAgLmZvckVhY2goa2V5ID0+IHtcbiAgICAgIGxvZ2dlcltrZXldID0gKC4uLnBhcmFtcykgPT4ge1xuICAgICAgICBpZiAoaXNVbmRlZmluZWQocGFyYW1zWzFdKSkgcGFyYW1zWzFdID0ge307XG4gICAgICAgIGVsc2UgcGFyYW1zWzFdID0gdGhpcy5wYXJzZUFyZyhwYXJhbXNbMV0pO1xuICAgICAgICAvLyBhZGQgYHJlcXVlc3RgIG9iamVjdCB0byBtZXRhZGF0YVxuICAgICAgICBPYmplY3QuYXNzaWduKFxuICAgICAgICAgIHBhcmFtc1sxXSxcbiAgICAgICAgICBwYXJzZVJlcXVlc3QoXG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKFxuICAgICAgICAgICAgICBpc0V4cHJlc3MgPyB7IHJlcSB9IDogeyBjdHggfSxcbiAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgLy8gdGhpcyBzeW1ib2wgd2FzIG5vdCBhZGRlZCB1bnRpbCBOb2RlIHY3LjcuMFxuICAgICAgICAgICAgICAvLyBhbmQgd2UgdHJ5IHRvIHN1cHBvcnQgTm9kZSB2Ni40K1xuICAgICAgICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2lzc3Vlcy8xNzc0NT5cbiAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9ibG9iL3Y3LjEwLjAvbGliL19odHRwX291dGdvaW5nLmpzI0wzNzktTDM4MD5cbiAgICAgICAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9ibG9iL3Y3LjcuMC9saWIvX2h0dHBfb3V0Z29pbmcuanMjTDM3OS1MMzgwPlxuICAgICAgICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2Jsb2IvdjYuNC4wL2xpYi9faHR0cF9vdXRnb2luZy5qcyNMMzUxLUwzNTI+XG4gICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBmb3IgdGhlIGZhbGxiYWNrIGBfaGVhZGVyc2AgYWxsIHRoZSBrZXlzIGFyZSBsb3dlcmNhc2VkXG4gICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgIC8vIEJ1dCBub3RlIHRoYXQgaW4gbm9kZSB2MTIuNC4wIGZvciBpbnN0YW5jZSB0aGlzIHByb3AgaXMgZGVwcmVjYXRlZFxuICAgICAgICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL25vZGVqcy9ub2RlL2Jsb2IvdjEyLjQuMC9saWIvX2h0dHBfb3V0Z29pbmcuanMjTDExNj5cbiAgICAgICAgICAgICAgLy8gU28gd2UgYXJlIGxlZnQgd2l0aCBlaXRoZXIgdGhlIFN5bWJvbCBvciB1c2Ugb2YgYGdldEhlYWRlcnNgXG4gICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgIC8vIEhPV0VWRVIgYXV0b21hdGljIHByb3BlcnRpZXMgbGlrZSBEYXRlIGhlYWRlciBhcmVuJ3RcbiAgICAgICAgICAgICAgLy8gc2V0IHdoZW4geW91IGRvIGBnZXRIZWFkZXJzYCwgdGhleSBhcmUgb25seSB3cml0dGVuIHRvIGBfaGVhZGVyYFxuICAgICAgICAgICAgICAvLyBhbmQgc28gd2UgbmVlZCBgcGFyc2UtcmVxdWVzdGAgdG8gcGFyc2UgdGhlIGByZXNwb25zZUhlYWRlcnNgXG4gICAgICAgICAgICAgIC8vIGFzIGEgU3RyaW5nIHVzaW5nIGBodHRwLWhlYWRlcnNgLi4uXG4gICAgICAgICAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvaXNzdWVzLzI4MzAyPlxuICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAvLyBub3RlIHRoYXQgSFRUUDIgcmVzcG9uc2VzIGRvIG5vdCBoYXZlIGEgU3RyaW5nIHZhbHVlXG4gICAgICAgICAgICAgIC8vIGZvciBgcmVzLl9oZWFkZXJgLCBhbmQgaW5zdGVhZCBpcyBhIEJvb2xlYW4gdmFsdWVcbiAgICAgICAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9pc3N1ZXMvMzA4OTQ+XG4gICAgICAgICAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vY2FiaW5qcy9jYWJpbi9pc3N1ZXMvMTMzPlxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzOlxuICAgICAgICAgICAgICAgICAgdHlwZW9mIHJlcy5faGVhZGVyID09PSAnc3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICA/IHJlcy5faGVhZGVyXG4gICAgICAgICAgICAgICAgICAgIDogdHlwZW9mIHJlcy5nZXRIZWFkZXJzID09PSAnZnVuY3Rpb24nXG4gICAgICAgICAgICAgICAgICAgID8gcmVzLmdldEhlYWRlcnMoKVxuICAgICAgICAgICAgICAgICAgICA6IG51bGxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgdGhpcy5jb25maWcucGFyc2VSZXF1ZXN0XG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2dlcltrZXldKC4uLltdLnNsaWNlLmNhbGwocGFyYW1zKSk7XG4gICAgICB9O1xuICAgIH0pO1xuICAvLyB1cG9uIGNvbXBsZXRpb24gb2YgYSByZXNwb25zZSB3ZSBuZWVkIHRvIGxvZyBpdFxuICBvbkZpbmlzaGVkKHJlcywgZXJyID0+IHtcbiAgICBpZiAoZXJyKSBsb2dnZXIuZXJyb3IoZXJyKTtcbiAgICBsZXQgbGV2ZWwgPSAnaW5mbyc7XG4gICAgaWYgKHJlcy5zdGF0dXNDb2RlID49IDUwMCkgbGV2ZWwgPSAnZXJyb3InO1xuICAgIGVsc2UgaWYgKHJlcy5zdGF0dXNDb2RlID49IDQwMCkgbGV2ZWwgPSAnd2Fybic7XG4gICAgY29uc3QgbWVzc2FnZSA9IHRoaXMuY29uZmlnLm1lc3NhZ2UoXG4gICAgICBPYmplY3QuYXNzaWduKHsgbGV2ZWwsIHJlcSwgcmVzIH0sIGlzRXhwcmVzcyA/IHt9IDogeyBjdHg6IGFyZ3NbMF0gfSlcbiAgICApO1xuICAgIGlmIChlcnIpIGxvZ2dlcltsZXZlbF0obWVzc2FnZSwgeyBlcnIgfSk7XG4gICAgZWxzZSBsb2dnZXJbbGV2ZWxdKG1lc3NhZ2UpO1xuICB9KTtcbiAgLy8gYWRkIGBsb2dgIChzaG9ydGhhbmQpIGFuZCBgbG9nZ2VyYCBtZXRob2RzXG4gIC8vIGByZXEubG9nYFxuICAvLyBgcmVzLmxvZ2BcbiAgLy8gYGN0eC5yZXFgXG4gIC8vIGBjdHgucmVzYFxuICAvLyBgY3R4LnJlcXVlc3RgXG4gIC8vIGBjdHgucmVzcG9uc2VgXG4gIC8vIDxodHRwczovL2dpdGh1Yi5jb20vcGlub2pzL2tvYS1waW5vLWxvZ2dlci9pc3N1ZXMvMTQ+XG4gIC8vIDxodHRwczovL2dpdGh1Yi5jb20vcGlub2pzL2tvYS1waW5vLWxvZ2dlci9ibG9iL21hc3Rlci9sb2dnZXIuanMjTDExPlxuICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL3Bpbm9qcy9waW5vLWh0dHAvYmxvYi9tYXN0ZXIvbG9nZ2VyLmpzI0w1NT5cbiAgaWYgKGlzRXhwcmVzcykge1xuICAgIHJlcS5sb2cgPSBsb2dnZXI7XG4gICAgcmVzLmxvZyA9IGxvZ2dlcjtcbiAgICByZXEubG9nZ2VyID0gbG9nZ2VyO1xuICAgIHJlcy5sb2dnZXIgPSBsb2dnZXI7XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY3R4ID0gYXJnc1swXTtcbiAgICBjdHgubG9nID0gbG9nZ2VyO1xuICAgIGN0eC5sb2dnZXIgPSBsb2dnZXI7XG4gICAgY3R4LnJlcXVlc3QubG9nID0gbG9nZ2VyO1xuICAgIGN0eC5yZXF1ZXN0LmxvZ2dlciA9IGxvZ2dlcjtcbiAgICBjdHgucmVzcG9uc2UubG9nID0gbG9nZ2VyO1xuICAgIGN0eC5yZXNwb25zZS5sb2dnZXIgPSBsb2dnZXI7XG4gIH1cblxuICByZXR1cm4gbmV4dCgpO1xufTtcbiJdfQ==